---
import type { GetStaticPaths } from 'astro';
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { findPumlFiles } from '../../lib/plantuml.mjs';
import { join } from 'node:path';

export const getStaticPaths: GetStaticPaths = async () => {
  const umlDir = join(process.cwd(), '..', 'uml');
  const files = await findPumlFiles(umlDir, umlDir, { includeContent: true });

  return files.map(file => ({
    params: { slug: file.relativePath.replace(/\.puml$/, '') },
    props: { 
      content: file.content!, 
      slug: file.relativePath.replace(/\.puml$/, '') 
    },
  }));
};

interface Props {
  content: string;
  slug: string;
}

const { content, slug } = Astro.props;
const title = slug.split('/').pop() || slug;

// Referenz auf die während des Builds generierte SVG-Datei
// import.meta.env.BASE_URL enthält den base-Pfad (z.B. "/c4-astro/")
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;
const diagramUrl = `${base}uml-generated/${slug}.svg`;
---

<StarlightPage frontmatter={{ title, description: `UML Diagramm: ${title}` }}>
  <div class="plantuml-diagram">
    <img 
      src={diagramUrl} 
      alt={`UML Diagramm: ${title}`} 
      class="plantuml-img"
      loading="lazy"
    />
  </div>
  
  <details class="plantuml-source">
    <summary>PlantUML Quellcode anzeigen</summary>
    <pre><code>{content}</code></pre>
  </details>
</StarlightPage>

<style>
  .plantuml-diagram {
    text-align: center;
    margin: 1.5rem 0;
    padding: 1rem;
    background: var(--sl-color-bg-nav);
    border-radius: 0.5rem;
    border: 1px solid var(--sl-color-gray-5);
  }

  .plantuml-img {
    max-width: 100%;
    height: auto;
  }

  .plantuml-source {
    margin-top: 1.5rem;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .plantuml-source summary {
    padding: 0.75rem 1rem;
    background: var(--sl-color-bg-nav);
    cursor: pointer;
    font-weight: 500;
  }

  .plantuml-source summary:hover {
    background: var(--sl-color-gray-6);
  }

  .plantuml-source pre {
    margin: 0;
    padding: 1rem;
    overflow-x: auto;
  }

  .plantuml-source code {
    font-size: 0.875rem;
  }
</style>
