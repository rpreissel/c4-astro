---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import FileTreeNode from '../../components/FileTreeNode.astro';
import { findPumlFiles } from '../../lib/plantuml.mjs';
import { join } from 'node:path';

interface FileNode {
  name: string;
  path: string;
  isDirectory: boolean;
  children: FileNode[];
}

// Lade alle .puml-Dateien
const umlDir = join(process.cwd(), '..', 'uml');
const files = await findPumlFiles(umlDir, umlDir);

// Baue hierarchische Baumstruktur
function buildTree(files: { relativePath: string }[]): FileNode[] {
  const root: FileNode[] = [];
  
  for (const file of files) {
    const parts = file.relativePath.replace(/\.puml$/, '').split('/');
    let current = root;
    
    for (let i = 0; i < parts.length; i++) {
      const part = parts[i];
      const isLast = i === parts.length - 1;
      const path = parts.slice(0, i + 1).join('/');
      
      let node = current.find(n => n.name === part);
      
      if (!node) {
        node = {
          name: part,
          path: path,
          isDirectory: !isLast,
          children: [],
        };
        current.push(node);
      }
      
      if (!isLast) {
        current = node.children;
      }
    }
  }
  
  // Sortiere: Ordner zuerst, dann alphabetisch
  function sortNodes(nodes: FileNode[]): FileNode[] {
    nodes.sort((a, b) => {
      if (a.isDirectory !== b.isDirectory) {
        return a.isDirectory ? -1 : 1;
      }
      return a.name.localeCompare(b.name);
    });
    nodes.forEach(n => sortNodes(n.children));
    return nodes;
  }
  
  return sortNodes(root);
}

const tree = buildTree(files);
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;
---

{/* Rekursive Render-Funktion */}
{(() => {
  const renderNodes = (nodes: FileNode[], level: number = 0): any[] => {
    return nodes.map((node) => {
      if (node.isDirectory) {
        return (
          <details class="folder-accordion" style={`--level: ${level}`}>
            <summary class="folder-header">{node.name}/</summary>
            <div class="folder-content">
              {renderNodes(node.children, level + 1)}
            </div>
          </details>
        );
      } else {
        return (
          <a href={`${base}uml/${node.path}/`} class="tree-file" style={`--level: ${level}`}>
            {node.name}
          </a>
        );
      }
    });
  };

  return null; // Diese Funktion wird nur definiert, nicht gerendert
})()}
---

<StarlightPage frontmatter={{ title: 'UML Diagramme', description: 'Ãœbersicht aller PlantUML-Diagramme' }}>
  <p class="intro">
    Alle verfÃ¼gbaren PlantUML-Diagramme in diesem Projekt:
  </p>
  
  <div class="file-tree">
    <div class="tree-root">uml/</div>
    {tree.map((node) => (
      <FileTreeNode node={node} level={0} base={base} />
    ))}
  </div>
</StarlightPage>

<style>
  .intro {
    margin-bottom: 1.5rem;
    color: var(--sl-color-gray-2);
  }

  .file-tree {
    font-family: var(--__sl-font-mono);
    font-size: 0.9rem;
    line-height: 1.6;
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    padding: 1rem 1.5rem;
    overflow-x: auto;
  }

  .tree-root {
    font-weight: 600;
    color: var(--sl-color-white);
    margin-bottom: 0.75rem;
  }
</style>

<style is:global>
  /* Akkordeon-Ordner */
  .file-tree .folder-accordion {
    margin: 0.25rem 0;
    margin-left: calc(var(--level, 0) * 1.5rem);
  }

  .file-tree .folder-header {
    cursor: pointer;
    user-select: none;
    color: var(--sl-color-text);
    font-weight: 500;
    padding: 0.25rem 0;
    list-style: none;
    display: flex;
    align-items: center;
  }

  .file-tree .folder-header::-webkit-details-marker {
    display: none;
  }

  .file-tree .folder-header::before {
    content: 'â–¶';
    display: inline-block;
    margin-right: 0.5rem;
    font-size: 0.7em;
    transition: transform 0.2s ease;
    color: var(--sl-color-gray-3);
  }

  .file-tree .folder-accordion[open] > .folder-header::before {
    transform: rotate(90deg);
  }

  .file-tree .folder-header:hover {
    color: var(--sl-color-white);
  }

  .file-tree .folder-header:hover::before {
    color: var(--sl-color-text-accent);
  }

  /* Ordner-Inhalt */
  .file-tree .folder-content {
    margin-top: 0.25rem;
  }

  /* Dateien */
  .file-tree .tree-file {
    display: block;
    color: var(--sl-color-text-accent);
    text-decoration: none;
    padding: 0.25rem 0;
    margin-left: calc(var(--level, 0) * 1.5rem);
    margin-top: 0.25rem;
  }

  .file-tree .tree-file:hover {
    text-decoration: underline;
    color: var(--sl-color-white);
  }

  .file-tree .tree-file::before {
    content: 'ðŸ“„ ';
    margin-right: 0.5rem;
  }
</style>
