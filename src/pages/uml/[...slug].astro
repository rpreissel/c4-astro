---
import type { GetStaticPaths } from 'astro';
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import plantumlEncoder from 'plantuml-encoder';

/**
 * PlantUML Server URL
 * Kann über die Umgebungsvariable PLANTUML_SERVER_URL überschrieben werden.
 * 
 * Beispiele:
 * - Öffentlicher Server: 'https://www.plantuml.com/plantuml/svg'
 * - Lokaler Docker: 'http://localhost:8080/svg'
 * - Eigener Server: 'https://plantuml.example.com/svg'
 */
const PLANTUML_SERVER_URL = import.meta.env.PLANTUML_SERVER_URL || 'https://www.plantuml.com/plantuml/svg';

export const getStaticPaths: GetStaticPaths = async () => {
  const { readdir, readFile } = await import('node:fs/promises');
  const { join } = await import('node:path');

  interface PumlFile {
    slug: string;
    content: string;
  }

  /**
   * Rekursiv alle .puml-Dateien im Verzeichnis finden und laden
   */
  async function getPumlFiles(dir: string, baseDir: string): Promise<PumlFile[]> {
    const entries = await readdir(dir, { withFileTypes: true });
    const files: PumlFile[] = [];

    for (const entry of entries) {
      const fullPath = join(dir, entry.name);
      if (entry.isDirectory()) {
        files.push(...await getPumlFiles(fullPath, baseDir));
      } else if (entry.name.endsWith('.puml')) {
        // Berechne relativen Pfad vom baseDir
        const relativePath = fullPath.substring(baseDir.length + 1);
        const slug = relativePath.replace(/\.puml$/, '');
        const content = await readFile(fullPath, 'utf-8');
        files.push({ slug, content });
      }
    }
    return files;
  }

  const umlDir = join(process.cwd(), 'uml');
  const files = await getPumlFiles(umlDir, umlDir);

  return files.map(file => ({
    params: { slug: file.slug },
    props: { content: file.content, slug: file.slug },
  }));
};

interface Props {
  content: string;
  slug: string;
}

const { content, slug } = Astro.props;
const title = slug.split('/').pop() || slug;

// PlantUML-Inhalt encodieren und Diagramm-URL generieren
const encoded = plantumlEncoder.encode(content);
const diagramUrl = `${PLANTUML_SERVER_URL}/${encoded}`;
---

<StarlightPage frontmatter={{ title, description: `UML Diagramm: ${title}` }}>
  <div class="plantuml-diagram">
    <img 
      src={diagramUrl} 
      alt={`UML Diagramm: ${title}`} 
      class="plantuml-img"
      loading="lazy"
    />
  </div>
  
  <details class="plantuml-source">
    <summary>PlantUML Quellcode anzeigen</summary>
    <pre><code>{content}</code></pre>
  </details>
</StarlightPage>

<style>
  .plantuml-diagram {
    text-align: center;
    margin: 1.5rem 0;
    padding: 1rem;
    background: var(--sl-color-bg-nav);
    border-radius: 0.5rem;
    border: 1px solid var(--sl-color-gray-5);
  }

  .plantuml-img {
    max-width: 100%;
    height: auto;
  }

  .plantuml-source {
    margin-top: 1.5rem;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .plantuml-source summary {
    padding: 0.75rem 1rem;
    background: var(--sl-color-bg-nav);
    cursor: pointer;
    font-weight: 500;
  }

  .plantuml-source summary:hover {
    background: var(--sl-color-gray-6);
  }

  .plantuml-source pre {
    margin: 0;
    padding: 1rem;
    overflow-x: auto;
  }

  .plantuml-source code {
    font-size: 0.875rem;
  }
</style>
